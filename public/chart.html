<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CPI Price Analytics | Advanced Charts</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.0.1/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.2.0/dist/chartjs-adapter-luxon.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <link rel="stylesheet" href="stylesheets/style.css">
  <link rel="stylesheet" href="stylesheets/product-charts.css">
  <link rel="stylesheet" href="stylesheets/navbar.css">
  <script src="javascripts/navbar-effects.js"></script>

  <style>
    :root {
      --primary-color: #4dabf7;
      --secondary-color: #74c0fc;
      --accent-color: #339af0;
      --background-light: #e7f5ff;
      --panel-color: #ffffff;
      --text-dark: #2c3e50;
      --text-light: #7f8c8d;
      --success: #20bf6b;
      --warning: #f39c12;
      --danger: #e74c3c;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--background-light);
      padding: 0;
      margin: 0;
      color: var(--text-dark);
    }

    .header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 2rem;
      position: relative;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      margin: 0;
      padding: 0;
      font-weight: 300;
      font-size: 2.2rem;
      text-align: center;
      color: white;
    }

    .header p {
      margin: 10px 0 0;
      text-align: center;
      opacity: 0.9;
      font-size: 1rem;
    }

    /* Removing inline navbar styles to use navbar.css consistently */

    .container {
      max-width: 1200px;
      margin: 30px auto;
      padding: 0 20px;
    }

    .products-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }

    .product-card {
      background-color: var(--panel-color);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      text-align: center;
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }

    .product-card h3 {
      margin-top: 0;
      color: var(--text-dark);
    }

    .product-card p {
      color: var(--text-light);
      margin-bottom: 15px;
    }

    .product-card a {
      display: inline-block;
      padding: 8px 16px;
      background-color: var(--primary-color);
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-weight: 500;
      transition: background-color 0.3s;
    }

    .product-card a:hover {
      background-color: var(--secondary-color);
    }

    .chart-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }

    .chart-card {
      background-color: var(--panel-color);
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      height: 100%;
      position: relative;
      height: 400px !important;
      max-height: 350px; /* Menambahkan max-height untuk mencegah chart melebar ke bawah */
      overflow: hidden; /* Menambahkan overflow hidden agar konten tidak keluar dari container */
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .chart-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-dark);
      margin: 0;
    }

    .chart-options {
      display: flex;
      gap: 5px;
    }

    .chart-option {
      background-color: #f1f5f9;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
      color: var(--text-dark);
      transition: all 0.2s;
      width: auto;
    }

    .chart-option:hover {
      background-color: #e2e8f0;
    }

    .chart-option.active {
      background-color: var(--primary-color);
      color: white;
    }

    .chart-canvas {
      height: 220px;
      width: 100%;
      min-height: 220px; /* Altura mínima para evitar cambios de diseño */
    }

    /* Estilos para indicador de carga */
    .chart-loading {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: rgba(255, 255, 255, 0.7);
      z-index: 10;
      border-radius: 12px;
    }

    .chart-loading::after {
      content: "";
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .stats-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 20px;
    }

    .stat-card {
      background-color: var(--panel-color);
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 700;
      margin: 8px 0;
      color: var(--primary-color);
    }

    .stat-label {
      font-size: 13px;
      color: var(--text-light);
    }

    .multi-chart-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-top: 20px;
    }

    .footer {
      background-color: var(--panel-color);
      text-align: center;
      padding: 20px;
      margin-top: 50px;
      color: var(--text-light);
      font-size: 14px;
    }

    @media (max-width: 991px) {
      .products-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .chart-container,
      .multi-chart-container {
        grid-template-columns: 1fr;
      }

      .stats-row {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 576px) {
      .products-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

<div class="header">
  <h1>CPI Price Analytics Dashboard</h1>
  <p>Advanced data visualization for Native Chicken price trends (2010-2014)</p>
</div>

<nav class="navbar">
  <div class="navbar-menu">
    <a href="index.html">Home</a>
    <a href="chart.html" class="active">Products Overview</a>
  </div>
</nav>

<div class="container">
  <h2>Select a Product for Detailed Analysis</h2>
  <div class="products-grid">
    <div class="product-card">
      <h3>中區紅羽土雞公上貨</h3>
      <p>Central Red Feather Native Chicken (Male)</p>
      <a href="central_red_feather_male.html">View Analysis</a>
    </div>

    <div class="product-card">
      <h3>中區紅羽土雞母上貨</h3>
      <p>Central Red Feather Native Chicken (Female)</p>
      <a href="central_red_feather_female.html">View Analysis</a>
    </div>

    <div class="product-card">
      <h3>嘉南紅羽土雞公上貨</h3>
      <p>Chiayi-Tainan Red Feather Native Chicken (Male)</p>
      <a href="chiayi_tainan_red_feather_male.html">View Analysis</a>
    </div>

    <div class="product-card">
      <h3>嘉南紅羽土雞母上貨</h3>
      <p>Chiayi-Tainan Red Feather Native Chicken (Female)</p>
      <a href="chiayi_tainan_red_feather_female.html">View Analysis</a>
    </div>

    <div class="product-card">
      <h3>高屏紅羽土雞公上貨</h3>
      <p>Kaohsiung-Pingtung Red Feather Native Chicken (Male)</p>
      <a href="kaohsiung_pingtung_red_feather_male.html">View Analysis</a>
    </div>

    <div class="product-card">
      <h3>高屏紅羽土雞母上貨</h3>
      <p>Kaohsiung-Pingtung Red Feather Native Chicken (Female)</p>
      <a href="kaohsiung_pingtung_red_feather_female.html">View Analysis</a>
    </div>

    <div class="product-card">
      <h3>嘉南紅羽土雞綜貨</h3>
      <p>Chiayi-Tainan Red Feather Native Chicken (Mixed)</p>
      <a href="chiayi_tainan_red_feather_mix.html">View Analysis</a>
    </div>

    <div class="product-card">
      <h3>黑羽土雞公舍飼</h3>
      <p>Black Feather Native Chicken (Male)</p>
      <a href="black_feather_male.html">View Analysis</a>
    </div>

    <div class="product-card">
      <h3>黑羽土雞母舍飼</h3>
      <p>Black Feather Native Chicken (Female)</p>
      <a href="black_feather_female.html">View Analysis</a>
    </div>
  </div>

  <h2>Market Overview Comparison</h2>
  <div class="stats-row">
    <div class="stat-card">
      <span class="stat-label">Market Average (All Products)</span>
      <span class="stat-value" id="marketAvg">-</span>
    </div>
    <div class="stat-card">
      <span class="stat-label">Price Range (All Products)</span>
      <span class="stat-value" id="marketRange">-</span>
    </div>
    <div class="stat-card">
      <span class="stat-label">Market Volatility</span>
      <span class="stat-value" id="marketVolatility">-</span>
    </div>
  </div>

  <div class="chart-container">
    <div class="chart-card">
      <div class="chart-header">
        <h3 class="chart-title">Male vs. Female vs. Mix Price Comparison</h3>
      </div>
      <canvas id="genderComparisonChart" class="chart-canvas"></canvas>
    </div>

    <div class="chart-card">
      <div class="chart-header">
        <h3 class="chart-title">Regional Price Comparison</h3>
      </div>
      <canvas id="regionalComparisonChart" class="chart-canvas"></canvas>
    </div>
  </div>

  <h2>Historical Trends Overview</h2>
  <div class="chart-container">
    <div class="chart-card">
      <div class="chart-header">
        <h3 class="chart-title">Yearly Average Price Trends</h3>
      </div>
      <canvas id="yearlyTrendChart" class="chart-canvas"></canvas>
    </div>

    <div class="chart-card">
      <div class="chart-header">
        <h3 class="chart-title">Seasonal Price Patterns</h3>
      </div>
      <canvas id="seasonalPatternChart" class="chart-canvas"></canvas>
    </div>
  </div>
</div>

<div class="footer">
  <p>CPI Price Analytics Dashboard &copy; 2025 | Data source: Historical CPI Dataset 2010-2014</p>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    fetchOverviewData();
  });

  async function fetchOverviewData() {
    try {
      // Fetch data for all products for overview comparison
      const productNames = [
        '中區紅羽土雞公上貨', '中區紅羽土雞母上貨',
        '嘉南紅羽土雞公上貨', '嘉南紅羽土雞母上貨',
        '高屏紅羽土雞公上貨', '高屏紅羽土雞母上貨',
        '嘉南紅羽土雞綜貨', '黑羽土雞公舍飼', '黑羽土雞母舍飼'
      ];

      let allProductsData = {};

      for (const product of productNames) {
        const params = new URLSearchParams();
        params.append('name', product);
        params.append('sort', 'date_asc');

        const response = await fetch('/api/prices?' + params.toString());
        const data = await response.json();

        if (data.length > 0) {
          allProductsData[product] = data;
        }
      }

      updateMarketStatistics(allProductsData);
      createGenderComparisonChart(allProductsData);
      createRegionalComparisonChart(allProductsData);
      createYearlyTrendChart(allProductsData);
      createSeasonalPatternChart(allProductsData);

    } catch (error) {
      console.error('Error fetching overview data:', error);
    }
  }

  function updateMarketStatistics(allProductsData) {
    // Calculate market-wide statistics
    let allPrices = [];

    for (const product in allProductsData) {
      const prices = allProductsData[product].map(item => parseFloat(item.price));
      allPrices = allPrices.concat(prices);
    }

    if (allPrices.length > 0) {
      const avg = allPrices.reduce((a, b) => a + b, 0) / allPrices.length;
      const min = Math.min(...allPrices);
      const max = Math.max(...allPrices);

      // Calculate standard deviation (volatility)
      const squareDiffs = allPrices.map(price => {
        const diff = price - avg;
        return diff * diff;
      });
      const avgSquareDiff = squareDiffs.reduce((a, b) => a + b, 0) / squareDiffs.length;
      const stdDev = Math.sqrt(avgSquareDiff);

      document.getElementById('marketAvg').textContent = avg.toFixed(2);
      document.getElementById('marketRange').textContent = `${min.toFixed(2)} - ${max.toFixed(2)}`;
      document.getElementById('marketVolatility').textContent = stdDev.toFixed(2);
    }
  }

  function createGenderComparisonChart(allProductsData) {
    // Group male vs female products for comparison
    const maleProducts = ['中區紅羽土雞公上貨', '嘉南紅羽土雞公上貨', '高屏紅羽土雞公上貨', '黑羽土雞公舍飼'];
    const femaleProducts = ['中區紅羽土雞母上貨', '嘉南紅羽土雞母上貨', '高屏紅羽土雞母上貨', '黑羽土雞母舍飼'];
    const mixProducts = ['嘉南紅羽土雞綜貨'];

    // Calculate monthly averages for each gender
    const monthlyData = processMonthlyAverages(allProductsData, maleProducts, femaleProducts, mixProducts);

    const ctx = document.getElementById('genderComparisonChart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: monthlyData.labels,
        datasets: [
          {
            label: 'Male Average',
            data: monthlyData.maleAvg,
            borderColor: '#2e86de',
            backgroundColor: 'rgba(46, 134, 222, 0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 3,
            pointBackgroundColor: '#ffffff',
            pointBorderColor: '#2e86de',
            pointBorderWidth: 2,
            pointHitRadius: 5
          },
          {
            label: 'Female Average',
            data: monthlyData.femaleAvg,
            borderColor: '#ff6b6b',
            backgroundColor: 'rgba(255, 107, 107, 0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 3,
            pointBackgroundColor: '#ffffff',
            pointBorderColor: '#ff6b6b',
            pointBorderWidth: 2,
            pointHitRadius: 5
          },
          {
            label: 'Mixed Average',
            data: monthlyData.mixAvg,
            borderColor: '#28a745',
            backgroundColor: 'rgba(40, 167, 69, 0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 3,
            pointBackgroundColor: '#ffffff',
            pointBorderColor: '#28a745',
            pointBorderWidth: 2,
            pointHitRadius: 5
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top',
            labels: { boxWidth: 12, font: { size: 10 } }
          }
        },
        scales: {
          x: {
            grid: { display: false },
            ticks: { maxTicksLimit: 6, font: { size: 10 } },
            title: {
              display: true,
              // text: 'Month/Year',
              padding: 10,
              font: { size: 12 }
            }
          },
          y: {
            beginAtZero: false,
            ticks: { font: { size: 10 } },
            title: {
              display: true,
              text: 'Price',
              font: { size: 12 }
            }
          }
        }
      }
    });
  }

  function createRegionalComparisonChart(allProductsData) {
    // Group by region for comparison
    const centralProducts = ['中區紅羽土雞公上貨', '中區紅羽土雞母上貨'];
    const chiayiTainanProducts = ['嘉南紅羽土雞公上貨', '嘉南紅羽土雞母上貨', '嘉南紅羽土雞綜貨'];
    const kaohsiungPingtungProducts = ['高屏紅羽土雞公上貨', '高屏紅羽土雞母上貨'];

    // Calculate regional averages
    const regionalData = processRegionalAverages(
      allProductsData,
      centralProducts,
      chiayiTainanProducts,
      kaohsiungPingtungProducts
    );

    const ctx = document.getElementById('regionalComparisonChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: regionalData.labels,
        datasets: [
          {
            label: 'Central',
            data: regionalData.centralAvg,
            backgroundColor: '#2e86de'
          },
          {
            label: 'Chiayi-Tainan',
            data: regionalData.chiayiTainanAvg,
            backgroundColor: '#20bf6b'
          },
          {
            label: 'Kaohsiung-Pingtung',
            data: regionalData.kaohsiungPingtungAvg,
            backgroundColor: '#f39c12'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top',
            labels: { boxWidth: 12, font: { size: 10 } }
          }
        },
        scales: {
          x: {
            grid: { display: false },
            ticks: { maxTicksLimit: 6, font: { size: 10 } },
            title: {
              display: true,
              // text: 'Year-Quarter',
              padding: 10,
              font: { size: 12 }
            }
          },
          y: {
            beginAtZero: false,
            ticks: { font: { size: 10 } },
            title: {
              display: true,
              text: 'Average Price',
              font: { size: 12 }
            }
          }
        }
      }
    });
  }

  function createYearlyTrendChart(allProductsData) {
    // Calculate yearly averages for all products
    const yearlyData = processYearlyAverages(allProductsData);

    const ctx = document.getElementById('yearlyTrendChart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: yearlyData.years,
        datasets: [
          {
            label: 'Yearly Average Price',
            data: yearlyData.averages,
            borderColor: '#5758BB',
            backgroundColor: 'rgba(87, 88, 187, 0.1)',
            fill: true,
            tension: 0.4,
            pointRadius: 4,
            pointBackgroundColor: '#ffffff',
            pointBorderColor: '#5758BB',
            pointBorderWidth: 2
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top',
            labels: { boxWidth: 12, font: { size: 10 } }
          }
        },
        scales: {
          x: {
            grid: { display: false },
            ticks: { font: { size: 10 } },
            title: {
              display: true,
              // text: 'Year',
              padding: 10,
              font: { size: 12 }
            }
          },
          y: {
            beginAtZero: false,
            ticks: { font: { size: 10 } },
            title: {
              display: true,
              text: 'Average Price',
              font: { size: 12 }
            }
          }
        }
      }
    });
  }

  function createSeasonalPatternChart(allProductsData) {
    // Calculate seasonal patterns (monthly averages across all years)
    const seasonalData = processSeasonalPatterns(allProductsData);

    const ctx = document.getElementById('seasonalPatternChart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
        datasets: [
          {
            label: 'Monthly Average (All Years)',
            data: seasonalData,
            borderColor: '#e74c3c',
            backgroundColor: 'rgba(231, 76, 60, 0.1)',
            fill: true,
            tension: 0.4,
            pointRadius: 3,
            pointBackgroundColor: '#ffffff',
            pointBorderColor: '#e74c3c',
            pointBorderWidth: 2
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top',
            labels: { boxWidth: 12, font: { size: 10 } }
          }
        },
        scales: {
          x: {
            grid: { display: false },
            ticks: { font: { size: 10 } },
            title: {
              display: true,
              // text: 'Month',
              padding: 10,
              font: { size: 12 }
            }
          },
          y: {
            beginAtZero: false,
            ticks: { font: { size: 10 } },
            title: {
              display: true,
              text: 'Average Price',
              font: { size: 12 }
            }
          }
        }
      }
    });
  }

  function processMonthlyAverages(allProductsData, maleProducts, femaleProducts, mixProducts) {
    // Process data to get monthly averages for male, female, and mixed products
    const monthlyMale = {};
    const monthlyFemale = {};
    const monthlyMix = {};

    // Process male products
    for (const product of maleProducts) {
      if (!allProductsData[product]) continue;

      allProductsData[product].forEach(item => {
        const date = new Date(item.date);
        const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

        if (!monthlyMale[monthYear]) {
          monthlyMale[monthYear] = [];
        }

        monthlyMale[monthYear].push(parseFloat(item.price));
      });
    }

    // Process female products
    for (const product of femaleProducts) {
      if (!allProductsData[product]) continue;

      allProductsData[product].forEach(item => {
        const date = new Date(item.date);
        const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

        if (!monthlyFemale[monthYear]) {
          monthlyFemale[monthYear] = [];
        }

        monthlyFemale[monthYear].push(parseFloat(item.price));
      });
    }

    // Process mixed products
    for (const product of mixProducts) {
      if (!allProductsData[product]) continue;

      allProductsData[product].forEach(item => {
        const date = new Date(item.date);
        const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

        if (!monthlyMix[monthYear]) {
          monthlyMix[monthYear] = [];
        }

        monthlyMix[monthYear].push(parseFloat(item.price));
      });
    }

    // Calculate averages
    const months = [...new Set([...Object.keys(monthlyMale), ...Object.keys(monthlyFemale), ...Object.keys(monthlyMix)])].sort();
    const maleAvg = months.map(month => {
      if (!monthlyMale[month] || monthlyMale[month].length === 0) return null;
      return monthlyMale[month].reduce((a, b) => a + b, 0) / monthlyMale[month].length;
    });

    const femaleAvg = months.map(month => {
      if (!monthlyFemale[month] || monthlyFemale[month].length === 0) return null;
      return monthlyFemale[month].reduce((a, b) => a + b, 0) / monthlyFemale[month].length;
    });

    const mixAvg = months.map(month => {
      if (!monthlyMix[month] || monthlyMix[month].length === 0) return null;
      return monthlyMix[month].reduce((a, b) => a + b, 0) / monthlyMix[month].length;
    });

    // Format labels for display
    const labels = months.map(month => {
      const [year, monthNum] = month.split('-');
      return `${monthNum}/${year.slice(2)}`;
    });

    return { labels, maleAvg, femaleAvg, mixAvg };
  }

  function processRegionalAverages(
    allProductsData,
    centralProducts,
    chiayiTainanProducts,
    kaohsiungPingtungProducts
  ) {
    // Process data to get quarterly regional averages
    const centralQuarterly = {};
    const chiayiTainanQuarterly = {};
    const kaohsiungPingtungQuarterly = {};

    // Helper function to process products by region
    function processRegionProducts(products, quarterlyData) {
      for (const product of products) {
        if (!allProductsData[product]) continue;

        allProductsData[product].forEach(item => {
          const date = new Date(item.date);
          const year = date.getFullYear();
          const quarter = Math.floor(date.getMonth() / 3) + 1;
          const yearQuarter = `${year}-Q${quarter}`;

          if (!quarterlyData[yearQuarter]) {
            quarterlyData[yearQuarter] = [];
          }

          quarterlyData[yearQuarter].push(parseFloat(item.price));
        });
      }
    }

    // Process each region
    processRegionProducts(centralProducts, centralQuarterly);
    processRegionProducts(chiayiTainanProducts, chiayiTainanQuarterly);
    processRegionProducts(kaohsiungPingtungProducts, kaohsiungPingtungQuarterly);

    // Get all quarters
    const quarters = [...new Set([
      ...Object.keys(centralQuarterly),
      ...Object.keys(chiayiTainanQuarterly),
      ...Object.keys(kaohsiungPingtungQuarterly)
    ])].sort();

    // Calculate averages
    const centralAvg = quarters.map(quarter => {
      if (!centralQuarterly[quarter] || centralQuarterly[quarter].length === 0) return null;
      return centralQuarterly[quarter].reduce((a, b) => a + b, 0) / centralQuarterly[quarter].length;
    });

    const chiayiTainanAvg = quarters.map(quarter => {
      if (!chiayiTainanQuarterly[quarter] || chiayiTainanQuarterly[quarter].length === 0) return null;
      return chiayiTainanQuarterly[quarter].reduce((a, b) => a + b, 0) / chiayiTainanQuarterly[quarter].length;
    });

    const kaohsiungPingtungAvg = quarters.map(quarter => {
      if (!kaohsiungPingtungQuarterly[quarter] || kaohsiungPingtungQuarterly[quarter].length === 0) return null;
      return kaohsiungPingtungQuarterly[quarter].reduce((a, b) => a + b, 0) / kaohsiungPingtungQuarterly[quarter].length;
    });

    return {
      labels: quarters,
      centralAvg,
      chiayiTainanAvg,
      kaohsiungPingtungAvg
    };
  }

  function processYearlyAverages(allProductsData) {
    // Process data to get yearly averages across all products
    const yearlyPrices = {};

    // Collect all prices by year
    for (const product in allProductsData) {
      allProductsData[product].forEach(item => {
        const year = new Date(item.date).getFullYear();

        if (!yearlyPrices[year]) {
          yearlyPrices[year] = [];
        }

        yearlyPrices[year].push(parseFloat(item.price));
      });
    }

    // Calculate yearly averages
    const years = Object.keys(yearlyPrices).sort();
    const averages = years.map(year => {
      return yearlyPrices[year].reduce((a, b) => a + b, 0) / yearlyPrices[year].length;
    });

    return { years, averages };
  }

  function processSeasonalPatterns(allProductsData) {
    // Process data to get monthly averages across all years and products
    const monthlyPrices = Array(12).fill(0).map(() => []);

    // Collect all prices by month
    for (const product in allProductsData) {
      allProductsData[product].forEach(item => {
        const month = new Date(item.date).getMonth();
        monthlyPrices[month].push(parseFloat(item.price));
      });
    }

    // Calculate monthly averages
    return monthlyPrices.map(prices => {
      if (prices.length === 0) return null;
      return prices.reduce((a, b) => a + b, 0) / prices.length;
    });
  }
</script>

</body>
</html>
